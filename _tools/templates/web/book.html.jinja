<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <style>
        /* Embedded CSS for Recipe Book */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: {{ style.font.family|default('Georgia, serif') }}, serif;
            font-size: {{ style.html_font_size|default(style.base_font_size|default('12pt')) }};
            line-height: 1.6;
            color: #333;
            background-color: #fff;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2em 3em;
            position: relative;
        }

        /* Layout container for sidebar and content */
        .layout-container {
            display: flex;
            gap: 3em;
            align-items: flex-start;
        }

        .main-content {
            flex: 1;
            min-width: 0;
            max-width: 900px;
        }

        /* Sticky Navigation Sidebar */
        .sticky-nav {
            position: sticky;
            top: 2em;
            width: 280px;
            max-height: calc(100vh - 4em);
            overflow-y: auto;
            padding: 1.5em;
            background-color: #f8f8f8;
            border-radius: 6px;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .sticky-nav::-webkit-scrollbar {
            width: 6px;
        }

        .sticky-nav::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .sticky-nav::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .sticky-nav::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .sticky-nav h3 {
            font-size: 1.1em;
            margin: 0 0 1em 0;
            padding-bottom: 0.75em;
            border-bottom: 2px solid #333;
            text-transform: uppercase;
            font-weight: bold;
        }

        .sticky-nav h3 a {
            color: #333;
            text-decoration: none;
            transition: color 0.2s;
        }

        .sticky-nav h3 a:hover {
            color: #0066cc;
        }

        .sticky-nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .sticky-nav > ul > li {
            margin: 0.75em 0;
        }

        .sticky-nav .section-link {
            font-weight: bold;
            color: #333;
            text-decoration: none;
            display: block;
            padding: 0.4em 0;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }

        .sticky-nav .section-link:hover,
        .sticky-nav .section-link.active {
            color: #0066cc;
        }

        .sticky-nav .recipe-links {
            margin: 0.5em 0 1em 0;
            padding-left: 1em;
            border-left: 2px solid #ddd;
        }

        .sticky-nav .recipe-links li {
            margin: 0.35em 0;
        }

        .sticky-nav .recipe-link {
            color: #666;
            text-decoration: none;
            display: block;
            padding: 0.3em 0;
            font-size: 0.9em;
            transition: color 0.2s;
            line-height: 1.4;
        }

        .sticky-nav .recipe-link:hover,
        .sticky-nav .recipe-link.active {
            color: #0066cc;
            font-weight: 500;
        }

        /* Typography */
        h1 {
            font-size: 2.5em;
            margin: 1em 0 0.5em 0;
            text-align: center;
            font-weight: bold;
        }

        h2 {
            font-size: 2em;
            margin: 1.5em 0 0.75em 0;
            page-break-before: always;
            border-bottom: 2px solid #333;
            padding-bottom: 0.25em;
            text-transform: uppercase;
        }

        h3 {
            font-size: 1.5em;
            margin: 1.25em 0 0.5em 0;
            font-weight: bold;
        }

        h4 {
            font-size: 1.25em;
            margin: 1em 0 0.5em 0;
            font-weight: bold;
        }

        /* Title page */
        .title-page {
            text-align: center;
            page-break-after: always;
            padding: 2in 0;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .title-page h1 {
            font-size: 3em;
            margin-bottom: 0.5em;
        }

        .title-page .author {
            font-size: 1.5em;
            margin: 1em 0;
        }

        .title-page .date {
            font-size: 1.2em;
            margin: 1em 0;
        }

        .title-page .copyright {
            margin-top: 3em;
            padding-top: 2em;
            border-top: 1px solid #333;
        }

        /* Table of Contents */
        .toc {
            page-break-after: always;
        }

        .toc h2 {
            page-break-before: auto;
        }

        .toc > ul {
            list-style: none;
            margin: 1em 0;
            display: flex;
            flex-wrap: wrap;
            gap: 2em;
        }

        .toc > ul > li {
            flex: 1 1 calc(50% - 2em);
            min-width: 300px;
            margin: 0;
            padding: 0;
        }

        .toc > ul > li > strong {
            display: block;
            margin-bottom: 0.5em;
            padding-bottom: 0.5em;
            font-size: 1.1em;
            border-bottom: 1px solid #e0e0e0;
        }

        .toc > ul > li > ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .toc > ul > li > ul > li {
            margin: 0.15em 0;
            line-height: 1.1;
            padding-left: 1em;
            text-indent: -1em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .toc a {
            text-decoration: none;
            color: #333;
            transition: color 0.2s;
        }

        .toc a:hover {
            color: #0066cc;
        }

        /* Section headers */
        .section-header {
            page-break-before: always;
            margin: 2em 0;
        }

        .section-divider {
            border: none;
            border-top: 1px solid #333;
            margin: 2em 0;
        }

        /* Recipe sections */
        .recipe {
            margin: 2.5em 0;
        }

        .recipe-title {
            font-size: 2em;
            text-align: center;
            margin: 1em 0;
            font-weight: bold;
        }

        /* Ingredients section */
        .ingredients {
            margin: 1.5em 0;
        }

        .ingredients h3 {
            margin-bottom: 0.75em;
        }

        .ingredients-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            column-gap: 1em;
            row-gap: 0.25em;
            margin: 1em 0;
        }

        .ingredient-item {
            display: flex;
            align-items: center;
            margin: 0;
            line-height: 1.0;
            gap: 0.5em;
        }

        .ingredient-name {
            flex: 0 1 auto;
            white-space: nowrap;
            min-width: 0;
        }

        .ingredient-item .dotfill {
            flex: 1 1 auto;
            min-width: 20px;
            height: 1em;
            margin: 0 0.5em;
            position: relative;
            display: flex;
            align-items: center;
        }

        /* Modern dot leader using SVG pattern for crisp, consistent dots */
        .ingredient-item .dotfill::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            margin: auto 0;
            height: 1px;
            background-image: url("data:image/svg+xml,%3Csvg width='6' height='2' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='1' cy='1' r='0.8' fill='%23666'/%3E%3C/svg%3E");
            background-repeat: repeat-x;
            background-size: 6px 2px;
        }

        .ingredient-amount {
            flex: 0 0 auto;
            white-space: nowrap;
            font-weight: 500;
            color: #444;
        }

        /* Directions section */
        .directions {
            margin: 1.5em 0;
        }

        .directions h3 {
            margin-bottom: 0.75em;
        }

        .directions ol,
        .directions ul {
            margin: 1em 0;
            padding-left: 2em;
        }

        .directions li {
            margin: 0;
            padding-left: 1em;
            line-height: 1.3;
        }

        /* Target all list items within recipes for directions */
        .recipe ol,
        .recipe ul {
            margin: 1em 0;
            padding-left: 2em;
        }

        .recipe ol li,
        .recipe ul li {
            margin: 0.4em;
            padding-left: 2em;
            line-height: 1.2;
        }

        /* Text formatting */
        em {
            font-style: italic;
        }

        strong {
            font-weight: bold;
        }

        /* Page breaks */
        .page-break {
            page-break-before: always;
        }

        hr.section-divider {
            border: none;
            border-top: 1px solid #333;
            margin: 2em 0;
        }

        .error {
            color: red;
            font-style: italic;
        }

        /* Print styles */
        @media print {
            .sticky-nav {
                display: none;
            }

            .layout-container {
                display: block;
            }

            body {
                max-width: 8.5in;
                padding: 0.5in;
            }
            
            .main-content {
                max-width: 100%;
            }

            h2 {
                page-break-before: always;
            }

            .recipe {
                page-break-inside: avoid;
            }

            .ingredients,
            .directions {
                page-break-inside: avoid;
            }
        }

        /* Responsive design */
        @media screen and (max-width: 1400px) {
            body {
                max-width: 100%;
                padding: 2em;
            }
        }

        @media screen and (max-width: 1200px) {
            body {
                padding: 1.5em;
            }
            
            .layout-container {
                gap: 2em;
            }
            
            .sticky-nav {
                width: 240px;
            }
        }

        @media screen and (max-width: 1024px) {
            .sticky-nav {
                display: none;
            }
            
            .main-content {
                max-width: 100%;
            }

            .toc > ul > li {
                flex: 1 1 calc(50% - 2em);
            }
        }

        @media screen and (max-width: 768px) {
            body {
                padding: 1em;
                font-size: 14px;
            }

            .ingredients-columns {
                grid-template-columns: 1fr;
            }

            .toc > ul > li {
                flex: 1 1 100%;
            }

            h1 {
                font-size: 2em;
            }

            h2 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="layout-container">
        <!-- Sticky Navigation Sidebar -->
        <nav class="sticky-nav">
            <h3><a href="#table-of-contents" class="section-link">Table of Contents</a></h3>
            <ul>
                {% for section_name, recipes in sections.items() %}
                <li>
                    <a href="#section-{{ section_name|url_safe_id }}" class="section-link" data-section="section-{{ section_name|url_safe_id }}">{{ section_name|upper }}</a>
                    <ul class="recipe-links">
                        {% for recipe in recipes %}
                        <li>
                            <a href="#recipe-{{ recipe.title|url_safe_id }}" class="recipe-link" data-recipe="recipe-{{ recipe.title|url_safe_id }}">{{ recipe.title }}</a>
                        </li>
                        {% endfor %}
                    </ul>
                </li>
                {% endfor %}
            </ul>
        </nav>

        <div class="main-content">
            <!-- Title Page -->
            <div class="title-page">
                <h1>{{ title }}</h1>
                <div class="author">{{ authorship.author }}</div>
                <div class="date">{{ authorship.date }}</div>
                <div class="copyright">
                    Copyright Â© 2024-{{ authorship.copyright }} {{ authorship.author }}<br>
                    All rights reserved.
                </div>
            </div>

            {% if include_toc %}
            <!-- Table of Contents -->
            <div class="toc" id="table-of-contents">
                <h2>Table of Contents</h2>
                <ul>
                    {% for section_name, recipes in sections.items() %}
                    <li>
                        <strong><a href="#section-{{ section_name|url_safe_id }}">{{ section_name|upper }}</a></strong>
                        <ul>
                            {% for recipe in recipes %}
                            <li><a href="#recipe-{{ recipe.title|url_safe_id }}">{{ recipe.title }}</a></li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% endfor %}
                </ul>
                <hr class="section-divider">
            </div>
            {% endif %}

            <!-- Recipe Sections -->
            {% for section_name, recipes in sections.items() %}
            <div class="section-header">
                <h2 id="section-{{ section_name|url_safe_id }}">{{ section_name|upper }}</h2>
                <hr class="section-divider">
            </div>

            {% for recipe in recipes %}
            <div class="recipe" id="recipe-{{ recipe.title|url_safe_id }}">
                <div class="recipe-title">{{ recipe.title }}</div>
                {{ recipe.html_content }}
                <hr class="section-divider">
            </div>
            {% endfor %}

            {% endfor %}
        </div>
    </div>

    <script>
        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                const href = this.getAttribute('href');
                if (href === '#') return;
                
                e.preventDefault();
                const target = document.querySelector(href);
                if (target) {
                    const offset = 80; // Offset for sticky header
                    const targetPosition = target.getBoundingClientRect().top + window.pageYOffset - offset;
                    window.scrollTo({
                        top: targetPosition,
                        behavior: 'smooth'
                    });
                    // Update URL without jumping
                    history.pushState(null, null, href);
                }
            });
        });

        // Active state tracking for navigation
        function updateActiveNav() {
            const sections = document.querySelectorAll('.section-header, .recipe');
            const navLinks = document.querySelectorAll('.sticky-nav a');
            
            // Remove all active classes
            navLinks.forEach(link => link.classList.remove('active'));
            
            // Find the current section/recipe in view
            let currentActive = null;
            const scrollPosition = window.scrollY + 150; // Offset for better UX
            
            sections.forEach(section => {
                const rect = section.getBoundingClientRect();
                const sectionTop = window.pageYOffset + rect.top;
                
                if (sectionTop <= scrollPosition) {
                    currentActive = section.id;
                }
            });
            
            // Set active class on corresponding nav link
            if (currentActive) {
                const activeLink = document.querySelector(`.sticky-nav a[href="#${currentActive}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                    
                    // Also highlight parent section link if it's a recipe
                    if (activeLink.classList.contains('recipe-link')) {
                        const parentLi = activeLink.closest('ul.recipe-links').closest('li');
                        const sectionLink = parentLi.querySelector('.section-link');
                        if (sectionLink) {
                            sectionLink.classList.add('active');
                        }
                    }
                }
            }
        }

        // Update active state on scroll
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(updateActiveNav, 50);
        });

        // Initial update
        updateActiveNav();
    </script>
</body>
</html>
